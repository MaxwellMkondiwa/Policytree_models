#rm(list=ls())
set.seed(2)
# Packages --------------------
library(sp)
library(rgdal)
library(dplyr)
library(rio)
library(readxl)
library(rgdal)
library(sf)
library(ggplot2)
library(grf)
library(mapview)
library(forcats)
library(bbplot)
suppressMessages(library(mapview))
load("LDS_Public_Workspace.RData")
LDS$Sowing_Date_Schedule_rating_num[LDS$Sowing_Date_Schedule=="T5_16Dec"]=1
LDS$Sowing_Date_Schedule_rating_num[LDS$Sowing_Date_Schedule=="T4_15Dec"]=2
LDS$Sowing_Date_Schedule_rating_num[LDS$Sowing_Date_Schedule=="T3_30Nov"]=3
LDS$Sowing_Date_Schedule_rating_num[LDS$Sowing_Date_Schedule=="T2_20Nov"]=4
LDS$Sowing_Date_Schedule_rating_num[LDS$Sowing_Date_Schedule=="T1_10Nov"]=5
LDS$Sowing_Date_Schedule=ordered(LDS$Sowing_Date_Schedule,levels=c("T5_16Dec","T4_15Dec","T3_30Nov","T2_20Nov","T1_10Nov"))
# Select variables needed for the analysis -----------------------------
LDSestim=subset(LDS, select=c("J.q5601_1herbName","D.q410_varName","Sowing_Date_Schedule_rating_num","G.q5305_irrigTimes_cat"
,"Sowing_Date_Schedule","Rabi2017_18","Sowing_Date_Early","Weedmanual","gpw_v4_population_density_rev11_2020_30_sec","M.q703_marketSaleShare","I.q5512_lodgingPercent","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num",
"I.q5504_floodSeverity_num","I.q5502_droughtSeverity_num","I.q5502_droughtSeverity","A.q114_socialCategory","A.q112_fEdu","A.q112_fEdu_new","G.q5301_irrigAvail_dum","G.q5305_irrigTimes_onevsall","G.q5305_irrigTimes_twovs1","G.q5305_irrigTimes_threevs1","G.q5305_irrigTimes_fourplusvs1","PumpEnergySource","IrrigSource","G.q5305_irrigTimes","D.q403_soilPerception"
,
"D.q401_soilTexture","D.q402_drainClass","PrevCropHarvestDayfor1stJan2017_num","D.prevCrop_Fallow","D.prevCrop_Rice","I.q5505_weedSeverity_num","L.q607_farmGatePricePerKg","L.tonPerHectare","C.q306_cropLarestAreaHA",
"G.q5305_irrigTimes","variety_type_NMWV","Nperha","NperhaSq","Nperha_100belowvsabove","Nperha_100belowvs100_150","Nperha_100belowvs150_200","Nperha_100belowvs200_250","Nperha_100belowvs200plus",
"P2O5perha","A.q111_fGenderdum","Weedmanaged","Weedherb","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Longitude","O.largestPlotGPS.Latitude","A.q103_district","temp.2008","precip.2008","temp.2009",
"precip.2009", "temp.2010","precip.2010","temp.2011","precip.2011","temp.2012","precip.2012","temp.2013","precip.2013","temp.2014","precip.2014","temp.2015","precip.2015","temp.2016",
"precip.2016","temp.2017","precip.2017"))
## Herbicides cleaning -----------------------
LDSestim$J.q5601_1herbName_2=gsub("([^A-Za-z0-9 ])+","", LDSestim$J.q5601_1herbName)
LDSestim$J.q5601_1herbName_2=as.character(LDSestim$J.q5601_1herbName_2)
LDSestim$J.q5601_1herbName_2[LDSestim$J.q5601_1herbName_2==""]="NA"
table(LDSestim$J.q5601_1herbName_2)
LDSestim$Herbicidename="NA"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("2  4 D","2 4 d","2-4 D","2 4 D","2 4d","2 4D","24 D","24d","2D","34D","hera","Hera","24D")]="2,4-D"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("SulfosulfuronMetsulfuron","SulfosulfuronMetsulfuron")]="SulfosulfuronMetsulfuron"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("CarfentrazoneSulfosulfuron","Carfentrazone")]="Carfentrazone"
# Metsulfuron -----------
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("Metsu","MetsulfuronClodinafop","Metsulfuronsulfosulfuron","Metsulfuron")]="Metsulfuron"
#Sulfusulfuran ---------------------------
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("Leader","Sufosulfuran","Sulfosufuran","Sulfosulfuran","Sulfosulfuron")]="Sulfosulfuron"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("Pendimethalin","Pendimethillin","Pendia","Penida","Stomp","Pendimethalin")]="Pendimethalin"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("TOTAL","Totak","total","Tal","Total")]="Total"
LDSestim$Herbicidename[LDSestim$J.q5601_1herbName_2%in%c("unknown","Unknown")]="Unknown"
LDSestim$Herbicidename[LDSestim$Weedmanual==1 & LDSestim$Weedherb==1]="Manual_herb"
LDSestim$Herbicidename[LDSestim$Weedmanual==1 & LDSestim$Weedherb==0]="Manual"
LDSestim$Herbicidename[is.na(LDSestim$J.q5601_1herbName_2) & LDSestim$Weedherb==1]="Unknown"
LDSestim$Herbicidename[LDSestim$Weedmanaged==0]="None"
LDSestim$Herbicidename[is.na(LDSestim$J.q5601_1herbName_2) & LDSestim$Weedherb==0 & LDSestim$Weedmanual==0]="None"
table(LDSestim$Herbicidename,LDSestim$Weedherb) # There are some observations where herbicide times is 0 but they recorded the herbicide name. We treated these as no herbicide application
table(LDSestim$J.q5601_1herbName_2,LDSestim$Weedherb)
LDSestim$Herbicidename_cat=NA
LDSestim$Herbicidename_cat[LDSestim$Herbicidename=="None"]="No weeding"
LDSestim$Herbicidename_cat[LDSestim$Herbicidename=="2,4-D"]="2,4-D"
LDSestim$Herbicidename_cat[LDSestim$Herbicidename=="Manual"]="Manual"
LDSestim$Herbicidename_cat[LDSestim$Herbicidename=="Manual_herb"]="Manual_herb"
LDSestim$Herbicidename_cat[LDSestim$Herbicidename%in%c("SulfosulfuronMetsulfuron","Total")]="SulfosulfuronMetsulfuron"
LDSestim$Herbicidename_cat=ordered(LDSestim$Herbicidename_cat,levels=c("No weeding","Manual","Manual_herb","2,4-D","SulfosulfuronMetsulfuron"))
table(LDSestim$Sowing_Date_Schedule)
LDSestim$D.q410_varName[LDSestim$D.q410_varName=="ShriRam 303"]="SUPER303"
LDSestim_variety = subset(LDSestim, LDSestim$D.q410_varName %in% c("PBW343", "UP262", "LOK1", "HD2967", "PBW154", "Kedar", "SUPER303", "PBW502", "HD2733", "HUW234", "RR21", "Local"))
LDSestim_variety$D.q410_varName=ordered(LDSestim_variety$D.q410_varName,levels=c("HD2967","Local","PBW343","UP262","LOK1","PBW154","Kedar","SUPER303","PBW502","HD2733","HUW234","RR21"))
# Bar graphs showing percentage of farmers adopting these practices
library(tidyverse)
library(ggplot2)
bar_chart=function(dat,var){
dat|>
drop_na({{var}})|>
mutate({{var}}:=factor({{var}})|>fct_infreq())|>
ggplot()+
geom_bar(aes(y={{var}}),width = 0.3,fill="dodgerblue4")+
theme_minimal(base_size = 16)
}
herb_plot=bar_chart(LDSestim,Herbicidename_cat)+labs(y="Weed management options")
herb_plot
sow_plot=bar_chart(LDSestim,Sowing_Date_Schedule)+labs(y="Sowing dates")
sow_plot
irrig_plot=bar_chart(LDSestim,G.q5305_irrigTimes_cat)+labs(y="Number of irrigations")
irrig_plot
variety_plot=bar_chart(LDSestim_variety,D.q410_varName)+labs(y="Variety")
variety_plot
library(ggpubr)
adoption_all=ggarrange(herb_plot,sow_plot,irrig_plot,variety_plot, ncol = 2,nrow=2)
adoption_all
ggsave("figures/adoption_all.png")
# Alternative graphs
Herbicidename_cat_n_perc=LDSestim%>%
dplyr::count(Herbicidename_cat, sort = TRUE) %>%
dplyr::mutate(Herbicidename_cat_n=     forcats::fct_rev(forcats::fct_inorder(Herbicidename_cat)),
Herbicidename_cat_n = forcats::fct_relevel(Herbicidename_cat, after = 0)) %>%
dplyr::mutate(herbpercent=paste0(sprintf("%4.1f",n/sum(n)*100),"%"))
library(forcats)
ggplot(Herbicidename_cat_n_perc, aes(x = n, y = Herbicidename_cat)) +
geom_col(fill = "dodgerblue4") +
## add percentage labels
geom_text(aes(label = herbpercent),hjust = 1, nudge_x = -.5,color="white") +
theme_minimal(base_size = 16)
# Error bar plots showing yield gains of each of the choices
## Weed management options
library(ggpubr)
library(tidyverse)
WeedMgt_Options_Errorplot=
LDSestim%>%
drop_na(Herbicidename_cat) %>%
ggerrorplot(x = "Herbicidename_cat", y = "L.tonPerHectare",add = "mean", error.plot = "errorbar", color="black",size=1,ggtheme=theme_bw())+
labs(x="Weed management options",y="Wheat yield (t/ha)")+
theme_bw(base_size = 16)+coord_flip()
WeedMgt_Options_Errorplot+
aes(x = fct_reorder(Herbicidename_cat, L.tonPerHectare))+
xlab("Weed management options")
#theme(axis.text = element_text(size = 20,colour = "black"))+theme(axis.title = element_text(size = 20))
ggsave("figures/WeedMgt_Options_Errorplot.png")
write.csv(LDSestim,"LDSestim.csv")
#Sowing dates
SowingDate_Options_Errorplot=
LDSestim%>%
drop_na(Sowing_Date_Schedule) %>%
ggerrorplot(x = "Sowing_Date_Schedule", y = "L.tonPerHectare",add = "mean", error.plot = "errorbar", color="black",size=1, ggtheme=theme_bw())+
labs(x="Sowing date options",y="Wheat yield (t/ha)")+
theme_bw(base_size = 16)+coord_flip()
SowingDate_Options_Errorplot+aes(x = fct_reorder(Sowing_Date_Schedule, L.tonPerHectare))+
xlab("Sowing date options")
ggsave("figures/SowingDate_Options_Errorplot.png",dpi=300)
# Irrigation schedules
Irrigation_Options_Errorplot=
LDSestim%>%
drop_na(G.q5305_irrigTimes_cat) %>%
ggerrorplot(x = "G.q5305_irrigTimes_cat", y = "L.tonPerHectare",add = "mean", error.plot = "errorbar",color="black",size=1, ggtheme=theme_bw())+
labs(x="Irrigation scheduling options",y="Wheat yield (t/ha)")+
theme_bw(base_size = 16)+coord_flip()
Irrigation_Options_Errorplot+ aes(x = fct_reorder(G.q5305_irrigTimes_cat, L.tonPerHectare))+
xlab("Irrigation scheduling options")
ggsave("figures/Irrigation_Options_Errorplot.png")
# Varieties
Variety_Options_Errorplot=
LDSestim_variety%>%
drop_na(D.q410_varName) %>%
ggerrorplot(x = "D.q410_varName", y = "L.tonPerHectare",add = "mean", error.plot = "errorbar", color="black",size=1, ggtheme=theme_bw())+
labs(x="Varietal options",y="Wheat yield (t/ha)")+
theme_bw(base_size = 16)+coord_flip()
Variety_Options_Errorplot+ aes(x = fct_reorder(D.q410_varName, L.tonPerHectare))+
xlab("Varietal options")
ggsave("figures/Variety_Options_Errorplot.png")
library(ggpubr)
mean_comparison_all=ggarrange(WeedMgt_Options_Errorplot,SowingDate_Options_Errorplot,Irrigation_Options_Errorplot,Variety_Options_Errorplot, ncol = 2,nrow=2)
mean_comparison_all
ggsave("figures/mean_comparison_all.png")
library(fBasics)
summ_stats <- fBasics::basicStats(LDSestim[,c("L.tonPerHectare","G.q5305_irrigTimes","Nperha","P2O5perha","Weedmanaged","variety_type_NMWV","Sowing_Date_Early")])
summ_stats <- as.data.frame(t(summ_stats))
# Rename some of the columns for convenience
summ_stats <- summ_stats[c("Mean", "Stdev", "Minimum", "1. Quartile", "Median",  "3. Quartile", "Maximum")] %>%
rename("Lower quartile" = '1. Quartile', "Upper quartile"= "3. Quartile")
summ_stats
#write.csv(summ_stats,"tables/summ_stats.csv")
# Correlation plot
# library(corrplot)
# Correlations=cor(LDSestim[,c("L.tonPerHectare","G.q5305_irrigTimes","Nperha","P2O5perha","Weedmanaged","variety_type_NMWV","Sowing_Date_Early")],na.rm=TRUE)
#
# Correlationsplot=corrplot(Correlations)
# Correlationsplot
library(modelsummary)
Sowpercent=datasummary_crosstab( ~ Sowing_Date_Schedule, data = LDSestim,output = 'data.frame')
Sowpercent=datasummary_crosstab(1 ~ Sowing_Date_Schedule, data = LDSestim,output = 'data.frame')
library(modelsummary)
Sowpercent=datasummary_crosstab(Sowing_Date_Schedule ~ , data = LDSestim,output = 'data.frame')
table(LDSestim$A.q103_district)
Sowpercent=datasummary(Sowing_Date_Schedule~N + Percent() , data = LDSestim,output = 'data.frame')
View(Sowpercent)
Varietypercent=datasummary(D.q410_varName~N + Percent() , data = LDSestim,output = 'data.frame')
Varietypercent
Varietypercent=datasummary(D.q410_varName~N + Percent() , data = LDSestim_variety,output = 'data.frame')
Varietypercent
Herbpercent=datasummary(Herbicidename_cat~N + Percent() , data = LDSestim,output = 'data.frame')
Herbpercent
Irrigpercent=datasummary(G.q5305_irrigTimes_cat~N + Percent() , data = LDSestim,output = 'data.frame')
Irrigpercent
Sowpercent=datasummary(Sowing_Date_Schedule+1~N + Percent() , data = LDSestim,output = 'data.frame')
Sowpercent
Varietypercent=datasummary(D.q410_varName+1~N + Percent() , data = LDSestim_variety,output = 'data.frame')
Varietypercent
Herbpercent=datasummary(Herbicidename_cat+1~N + Percent() , data = LDSestim,output = 'data.frame')
Herbpercent
Irrigpercent=datasummary(G.q5305_irrigTimes_cat+1~N + Percent() , data = LDSestim,output = 'data.frame')
Irrigpercent
LDSestim=subset(LDS, select=c("C.q307_largestPlotType","A.q114_socialCategory","A.q112_fEdu","A.q112_fEdu_new","","M.q702_hhMemAg","J.q5601_1herbName","D.q410_varName","Sowing_Date_Schedule_rating_num","G.q5305_irrigTimes_cat"
,"Sowing_Date_Schedule","Rabi2017_18","Sowing_Date_Early","Weedmanual","gpw_v4_population_density_rev11_2020_30_sec","M.q703_marketSaleShare","I.q5512_lodgingPercent","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num",
"I.q5504_floodSeverity_num","I.q5502_droughtSeverity_num","I.q5502_droughtSeverity","A.q114_socialCategory","A.q112_fEdu","A.q112_fEdu_new","G.q5301_irrigAvail_dum","G.q5305_irrigTimes_onevsall","G.q5305_irrigTimes_twovs1","G.q5305_irrigTimes_threevs1","G.q5305_irrigTimes_fourplusvs1","PumpEnergySource","IrrigSource","G.q5305_irrigTimes","D.q403_soilPerception"
,
"D.q401_soilTexture","D.q402_drainClass","PrevCropHarvestDayfor1stJan2017_num","D.prevCrop_Fallow","D.prevCrop_Rice","I.q5505_weedSeverity_num","L.q607_farmGatePricePerKg","L.tonPerHectare","C.q306_cropLarestAreaHA",
"G.q5305_irrigTimes","variety_type_NMWV","Nperha","NperhaSq","Nperha_100belowvsabove","Nperha_100belowvs100_150","Nperha_100belowvs150_200","Nperha_100belowvs200_250","Nperha_100belowvs200plus",
"P2O5perha","A.q111_fGenderdum","Weedmanaged","Weedherb","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Longitude","O.largestPlotGPS.Latitude","A.q103_district","temp.2008","precip.2008","temp.2009",
"precip.2009", "temp.2010","precip.2010","temp.2011","precip.2011","temp.2012","precip.2012","temp.2013","precip.2013","temp.2014","precip.2014","temp.2015","precip.2015","temp.2016",
"precip.2016","temp.2017","precip.2017"))
LDSestim=subset(LDS, select=c("C.q307_largestPlotType","A.q114_socialCategory","A.q112_fEdu","A.q112_fEdu_new","M.q702_hhMemAg","J.q5601_1herbName","D.q410_varName","Sowing_Date_Schedule_rating_num","G.q5305_irrigTimes_cat"
,"Sowing_Date_Schedule","Rabi2017_18","Sowing_Date_Early","Weedmanual","gpw_v4_population_density_rev11_2020_30_sec","M.q703_marketSaleShare","I.q5512_lodgingPercent","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num",
"I.q5504_floodSeverity_num","I.q5502_droughtSeverity_num","I.q5502_droughtSeverity","A.q114_socialCategory","A.q112_fEdu","A.q112_fEdu_new","G.q5301_irrigAvail_dum","G.q5305_irrigTimes_onevsall","G.q5305_irrigTimes_twovs1","G.q5305_irrigTimes_threevs1","G.q5305_irrigTimes_fourplusvs1","PumpEnergySource","IrrigSource","G.q5305_irrigTimes","D.q403_soilPerception"
,
"D.q401_soilTexture","D.q402_drainClass","PrevCropHarvestDayfor1stJan2017_num","D.prevCrop_Fallow","D.prevCrop_Rice","I.q5505_weedSeverity_num","L.q607_farmGatePricePerKg","L.tonPerHectare","C.q306_cropLarestAreaHA",
"G.q5305_irrigTimes","variety_type_NMWV","Nperha","NperhaSq","Nperha_100belowvsabove","Nperha_100belowvs100_150","Nperha_100belowvs150_200","Nperha_100belowvs200_250","Nperha_100belowvs200plus",
"P2O5perha","A.q111_fGenderdum","Weedmanaged","Weedherb","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Longitude","O.largestPlotGPS.Latitude","A.q103_district","temp.2008","precip.2008","temp.2009",
"precip.2009", "temp.2010","precip.2010","temp.2011","precip.2011","temp.2012","precip.2012","temp.2013","precip.2013","temp.2014","precip.2014","temp.2015","precip.2015","temp.2016",
"precip.2016","temp.2017","precip.2017"))
table(LDSestim$A.q112_fEdu_new)
table(LDSestim$A.q114_socialCategory)
table(LDSestim$C.q307_largestPlotType)
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="noSchooling"]=0
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="primary"]=1
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="matriculation"]=2
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="seniorSecondary"]=3
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="bachelors"]=4
LDSestim$A.q112_fEdu_new_num[LDSestim$A.q112_fEdu_new=="Postgrad"]=5
LDSestim$Caste_marginalized[LDSestim$A.q114_socialCategory=="General"]=0
LDSestim$Caste_marginalized[LDSestim$A.q114_socialCategory%in%c("OBC","Other","SC","ST")]=1
LDSestim$Plot_owned[LDSestim$C.q307_largestPlotType=="Owned"]=1
LDSestim$Plot_owned[LDSestim$C.q307_largestPlotType%in%c("FarmedContract","Leased")]=0
install.packages("DiagrammeRsvg")
library(DiagrammeRsvg)
cat(DiagrammeRsvg::export_svg(tr_variety), file = 'figures/tr_variety.svg')
table_varieties=sort(xtabs(~LDS$D.varName))
table_varieties
#LDSestim$D.q410_varName[LDSestim$D.q410_varName=="NL1"]=NA
LDSestim$D.q410_varName[LDSestim$D.q410_varName=="ShriRam 303"]="SUPER303"
LDSestim_variety=subset(LDSestim,LDSestim$D.q410_varName%in%c("PBW343","UP262","LOK1","HD2967","PBW154","Kedar","SUPER303","PBW502","HD2733","HUW234","RR21","Local"))
LDSestim_variety$D.q410_varName=ordered(LDSestim_variety$D.q410_varName,levels=c("HD2967","Local","PBW343","UP262","LOK1","PBW154","Kedar","SUPER303","PBW502","HD2733","HUW234","RR21"))
library(grf)
library(policytree)
LDSestim_variety=subset(LDSestim_variety, select=c("D.q410_varName","G.q5305_irrigTimes_cat","Sowing_Date_Schedule_rating_num","L.tonPerHectare","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num",                                       "Nperha","P2O5perha","variety_type_NMWV","G.q5305_irrigTimes","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude"))
library(tidyr)
LDSestim_variety=LDSestim_variety %>% drop_na()
Y_cf_variety=as.vector(LDSestim_variety$L.tonPerHectare)
## Causal random forest -----------------
X_cf_variety=subset(LDSestim_variety, select=c("I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num",
"Nperha","P2O5perha","G.q5305_irrigTimes","Sowing_Date_Schedule_rating_num","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude"))
W_cf_variety <- as.factor(LDSestim_variety$D.q410_varName)
W.multi_variety.forest <- probability_forest(X_cf_variety, W_cf_variety,
equalize.cluster.weights = FALSE,
seed = 2
)
W.hat.multi.all_variety <- predict(W.multi_variety.forest, estimate.variance = TRUE)$predictions
Y.multi_variety.forest <- regression_forest(X_cf_variety, Y_cf_variety,
equalize.cluster.weights = FALSE,
seed = 2
)
print(Y.multi_variety.forest)
varimp.multi_variety <- variable_importance(Y.multi_variety.forest)
Y.hat.multi.all_variety <- predict(Y.multi_variety.forest, estimate.variance = TRUE)$predictions
multi_variety.forest <- multi_arm_causal_forest(X = X_cf_variety, Y = Y_cf_variety, W = W_cf_variety,W.hat =W.hat.multi.all_variety , Y.hat=Y.hat.multi.all_variety, seed=1234)
multi_variety_ate=average_treatment_effect(multi_variety.forest, method="AIPW")
multi_variety_ate
#write.csv(multi_variety_ate,"tables/multi_variety_ate.csv")
varimp.multi_variety_cf <- variable_importance(multi_variety.forest)
vars_variety=c("I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num",
"Nperha","P2O5perha","G.q5305_irrigTimes","Sowing_Date_Schedule_rating_num","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude")
## variable importance plot ----------------------------------------------------
varimpvars_variety=as.data.frame(cbind(varimp.multi_variety_cf,vars_variety))
names(varimpvars_variety)[1]="Variableimportance_variety"
varimpvars_variety$Variableimportance_variety=formatC(varimpvars_variety$Variableimportance_variety, digits = 2, format = "f")
varimpvars_variety$Variableimportance_variety=as.numeric(varimpvars_variety$Variableimportance_variety)
varimpplotRF_variety=ggplot(varimpvars_variety,aes(x=reorder(vars_variety,Variableimportance_variety),y=Variableimportance_variety))+
geom_jitter(color="steelblue")+
coord_flip()+
labs(x="Variables",y="Variable importance")
previous_theme <- theme_set(theme_bw(base_size = 16))
varimpplotRF_variety
ggsave("figures/varimpplotRF_variety.png",dpi=300)
# Policy tree --------------------------------------
DR.scores_variety <- double_robust_scores(multi_variety.forest)
tr_variety <- policy_tree(X_cf_variety, DR.scores_variety, depth = 2)
tr_variety
plot(tr_variety)
tr_variety3 <- hybrid_policy_tree(X_cf_variety, DR.scores_variety, depth = 3)
tr_variety3
plot(tr_variety3)
tr_variety4 <- hybrid_policy_tree(X_cf_variety, DR.scores_variety, depth = 4)
tr_variety4
plot(tr_variety4)
tr_assignment_variety=LDSestim_variety
tr_assignment_variety$depth2 <- predict(tr_variety, X_cf_variety)
table(tr_assignment_variety$depth2)
tr_assignment_variety$depth3 <- predict(tr_variety3, X_cf_variety)
table(tr_assignment_variety$depth3)
tr_assignment_variety$depth4 <- predict(tr_variety4, X_cf_variety)
table(tr_assignment_variety$depth4)
#
# Saving a plot in a vectorized SVG format can be done with the `DiagrammeRsvg` package. install.packages("DiagrammeRsvg")
library(DiagrammeRsvg)
cat(DiagrammeRsvg::export_svg(tr_variety), file = 'figures/tr_variety.svg')
cat(DiagrammeRsvg::export_svg(tr_variety3), file = 'figures/tr_variety3.svg')
cat(DiagrammeRsvg::export_svg(tr_variety4), file = 'figures/tr_variety4.svg')
![](tr_variety.svg)
library(fastDummies)
LDSestim_Desc=fastDummies::dummy_cols(LDSestim, select_columns=c("G.q5305_irrigTimes_cat","Sowing_Date_Schedule","Herbicidename_cat","A.q112_fEdu_new"))
names(LDSestim_Desc)
library(fBasics)
summ_stats <- fBasics::basicStats(LDSestim[,c("L.tonPerHectare","G.q5305_irrigTimes",
"G.q5305_irrigTimes_cat_One","G.q5305_irrigTimes_cat_Two",                 "G.q5305_irrigTimes_cat_Three","G.q5305_irrigTimes_cat_Fourplus",             "G.q5305_irrigTimes_cat_NA","Sowing_Date_Schedule_T5_16Dec",               "Sowing_Date_Schedule_T4_15Dec","Sowing_Date_Schedule_T3_30Nov",             "Sowing_Date_Schedule_T2_20Nov","Sowing_Date_Schedule_T1_10Nov",             "A.q112_fEdu_new_noSchooling","A.q112_fEdu_new_primary","A.q112_fEdu_new_matriculation", "A.q112_fEdu_new_seniorSecondary",          "A.q112_fEdu_new_bachelors","A.q112_fEdu_new_Postgrad",                                      "Nperha","P2O5perha","Weedmanaged","variety_type_NMWV","Sowing_Date_Early","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num",                                       "Nperha","P2O5perha","G.q5305_irrigTimes","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","A.q111_fGenderdum","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm")])
summ_stats <- as.data.frame(t(summ_stats))
# Rename some of the columns for convenience
summ_stats <- summ_stats[c("Mean", "Stdev", "Minimum", "1. Quartile", "Median",  "3. Quartile", "Maximum")] %>%
rename("Lower quartile" = '1. Quartile', "Upper quartile"= "3. Quartile")
summ_stats
library(fBasics)
summ_stats <- fBasics::basicStats(LDSestim_Desc[,c("L.tonPerHectare","G.q5305_irrigTimes",
"G.q5305_irrigTimes_cat_One","G.q5305_irrigTimes_cat_Two",                 "G.q5305_irrigTimes_cat_Three","G.q5305_irrigTimes_cat_Fourplus",             "G.q5305_irrigTimes_cat_NA","Sowing_Date_Schedule_T5_16Dec",               "Sowing_Date_Schedule_T4_15Dec","Sowing_Date_Schedule_T3_30Nov",             "Sowing_Date_Schedule_T2_20Nov","Sowing_Date_Schedule_T1_10Nov",             "A.q112_fEdu_new_noSchooling","A.q112_fEdu_new_primary","A.q112_fEdu_new_matriculation", "A.q112_fEdu_new_seniorSecondary",          "A.q112_fEdu_new_bachelors","A.q112_fEdu_new_Postgrad",                                      "Nperha","P2O5perha","Weedmanaged","variety_type_NMWV","Sowing_Date_Early","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num",                                       "Nperha","P2O5perha","G.q5305_irrigTimes","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","A.q111_fGenderdum","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm")])
summ_stats <- as.data.frame(t(summ_stats))
# Rename some of the columns for convenience
summ_stats <- summ_stats[c("Mean", "Stdev", "Minimum", "1. Quartile", "Median",  "3. Quartile", "Maximum")] %>%
rename("Lower quartile" = '1. Quartile', "Upper quartile"= "3. Quartile")
summ_stats
library(fBasics)
summ_stats <- fBasics::basicStats(LDSestim_Desc[,c("L.tonPerHectare","G.q5305_irrigTimes",
"G.q5305_irrigTimes_cat_One","G.q5305_irrigTimes_cat_Two",                 "G.q5305_irrigTimes_cat_Three","G.q5305_irrigTimes_cat_Fourplus","Sowing_Date_Schedule_T5_16Dec",               "Sowing_Date_Schedule_T4_15Dec","Sowing_Date_Schedule_T3_30Nov",             "Sowing_Date_Schedule_T2_20Nov","Sowing_Date_Schedule_T1_10Nov",             "A.q112_fEdu_new_noSchooling","A.q112_fEdu_new_primary","A.q112_fEdu_new_matriculation", "A.q112_fEdu_new_seniorSecondary",          "A.q112_fEdu_new_bachelors","A.q112_fEdu_new_Postgrad",                                      "Nperha","P2O5perha","Weedmanaged","variety_type_NMWV","Sowing_Date_Early","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num",                                       "Nperha","P2O5perha","G.q5305_irrigTimes","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","A.q111_fGenderdum","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm")])
summ_stats <- as.data.frame(t(summ_stats))
# Rename some of the columns for convenience
summ_stats <- summ_stats[c("Mean", "Stdev", "Minimum", "1. Quartile", "Median",  "3. Quartile", "Maximum")] %>%
rename("Lower quartile" = '1. Quartile', "Upper quartile"= "3. Quartile")
summ_stats
names(tr_assignment_irrigsp)
library(grf)
library(policytree)
LDSestim_irrig=subset(LDSestim, select=c("L.tonPerHectare","G.q5305_irrigTimes_cat","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num","Nperha","P2O5perha","variety_type_NMWV","Sowing_Date_Schedule_rating_num","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude"))
library(tidyr)
LDSestim_irrig=LDSestim_irrig %>% drop_na()
Y_cf_irrig=as.vector(LDSestim_irrig$L.tonPerHectare)
## Causal random forest -----------------
X_cf_irrig=subset(LDSestim_irrig, select=c("I.q5505_weedSeverity_num","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num","Nperha","P2O5perha","variety_type_NMWV","Sowing_Date_Schedule_rating_num","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude"))
W_cf_irrig <- as.factor(LDSestim_irrig$G.q5305_irrigTimes_cat)
W.multi_irrig.forest <- probability_forest(X_cf_irrig, W_cf_irrig,
equalize.cluster.weights = FALSE,
seed = 2
)
W.hat.multi.all_irrig <- predict(W.multi_irrig.forest, estimate.variance = TRUE)$predictions
Y.multi_irrig.forest <- regression_forest(X_cf_irrig, Y_cf_irrig,
equalize.cluster.weights = FALSE,
seed = 2
)
print(Y.multi_irrig.forest)
varimp.multi_irrig <- variable_importance(Y.multi_irrig.forest)
Y.hat.multi.all_irrig <- predict(Y.multi_irrig.forest, estimate.variance = TRUE)$predictions
multi_irrig.forest <- multi_arm_causal_forest(X = X_cf_irrig, Y = Y_cf_irrig, W = W_cf_irrig,Y.hat =Y.hat.multi.all_irrig,W.hat =W.hat.multi.all_irrig)
multi_irrig_ate=average_treatment_effect(multi_irrig.forest, method="AIPW")
multi_irrig_ate
#write.csv(multi_irrig_ate,"tables/multi_irrig_ate.csv")
varimp.multi_irrig_cf <- variable_importance(multi_irrig.forest)
vars_irrig=c("I.q5505_weedSeverity_num","I.q5505_weedSeverity_num","I.q5509_diseaseSeverity_num","I.q5506_insectSeverity_num","I.q5502_droughtSeverity_num","Nperha","P2O5perha","variety_type_NMWV","Sowing_Date_Schedule_rating_num","A.q111_fGenderdum","Weedmanaged","temp","precip","wc2.1_30s_elev",
"M.q708_marketDistance","C.q306_cropLarestAreaHA","A.q112_fEdu_new_num","Caste_marginalized","Plot_owned","nitrogen_0.5cm","sand_0.5cm", "soc_5.15cm","O.largestPlotGPS.Latitude","O.largestPlotGPS.Longitude")
## variable importance plot ----------------------------------------------------
varimpvars_irrig=as.data.frame(cbind(varimp.multi_irrig_cf,vars_irrig))
names(varimpvars_irrig)[1]="Variableimportance_irrig"
varimpvars_irrig$Variableimportance_irrig=formatC(varimpvars_irrig$Variableimportance_irrig, digits = 2, format = "f")
varimpvars_irrig$Variableimportance_irrig=as.numeric(varimpvars_irrig$Variableimportance_irrig)
varimpplotRF_irrig=ggplot(varimpvars_irrig,aes(x=reorder(vars_irrig,Variableimportance_irrig),y=Variableimportance_irrig))+
geom_jitter(color="steelblue")+
coord_flip()+
labs(x="Variables",y="Variable importance")
previous_theme <- theme_set(theme_bw(base_size = 16))
varimpplotRF_irrig
ggsave("figures/varimpplotRF_irrig.png",dpi=300)
# Policy tree --------------------------------------
DR.scores_irrig <- double_robust_scores(multi_irrig.forest)
tr_irrig <- policy_tree(X_cf_irrig, DR.scores_irrig, depth = 2)
tr_irrig
plot(tr_irrig)
# Using greedy approach
# Depth 3 model
tr_irrig3 <- hybrid_policy_tree(X_cf_irrig, DR.scores_irrig, depth = 3)
tr_irrig3
plot(tr_irrig3)
# Depth 4 model
tr_irrig4 <- hybrid_policy_tree(X_cf_irrig, DR.scores_irrig, depth = 4)
tr_irrig4
plot(tr_irrig4)
# Treatment assignment
tr_assignment_irrig=LDSestim_irrig
tr_assignment_irrig$depth2 <- predict(tr_irrig, X_cf_irrig)
table(tr_assignment_irrig$depth2)
tr_assignment_irrig$depth3 <- predict(tr_irrig3, X_cf_irrig)
table(tr_assignment_irrig$depth3)
tr_assignment_irrig$depth4 <- predict(tr_irrig4, X_cf_irrig)
table(tr_assignment_irrig$depth4)
test_calibration(multi_irrig.forest)
mc.pred <- predict(multi_irrig.forest, drop = TRUE)
tau.hat <- mc.pred$predictions
tau.hat=as.data.frame(tau.hat)
View(tau.hat)
tau.multi_irrig.forest=predict(multi_irrig.forest, target.sample = "all",estimate.variance=TRUE)
tau.multi_irrig.forest=as.data.frame(tau.multi_irrig.forest)
tau.multi_irrig.forest_X=data.frame(LDSestim_irrig,tau.multi_irrig.forest)
# Ridges -------------------
tau.multi_irrig.forest_pred=tau.multi_irrig.forest[,1:3]
library(dplyr)
tau.multi_irrig.forest_pred=rename(tau.multi_irrig.forest_pred,"Two-One"="predictions.Two...One.Y.1")
tau.multi_irrig.forest_pred=rename(tau.multi_irrig.forest_pred,"Three-One"="predictions.Three...One.Y.1")
tau.multi_irrig.forest_pred=rename(tau.multi_irrig.forest_pred,"Four-One"="predictions.Fourplus...One.Y.1")
View(tau.multi_irrig.forest_X)
View(tau.multi_irrig.forest_pred)
View(tr_assignment_irrig)
tr_assignment_irrig_tau_pred=cbind(tr_assignment_irrig,tau.multi_irrig.forest_pred)
View(tr_assignment_irrig_tau_pred)
